<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="main.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script>
  <!-- Braintree Javascript SDKs -->
  <script src="https://pay.google.com/gp/p/js/pay.js"></script>
  <script src="https://js.braintreegateway.com/web/3.100.0/js/client.min.js"></script>
  <script src="https://js.braintreegateway.com/web/3.100.0/js/hosted-fields.min.js"></script>
  <script src="https://js.braintreegateway.com/web/3.100.0/js/data-collector.min.js"></script>
  <script src="https://js.braintreegateway.com/web/3.100.0/js/google-payment.min.js"></script>
  <script src="https://js.braintreegateway.com/web/3.100.0/js/apple-pay.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>


  <title>Payment Form - Review</title>
</head>
<style>
  /* Start Braintree Credit Card Input Styles */
  #securityCode,
  #expirationDate,
  #creditCardNumber,
  #nameOnCard,
  #billingZipCode {
    background-color: white;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
    width: 100%;
    line-height: 1.5;
    height: 2.5rem;
    padding: .1em .5em;
    color: #000;
  }

  .apple-pay-button {
    /*display: inline-block;*/
    -webkit-appearance: -apple-pay-button;
    -apple-pay-button-type: plain;
    -apple-pay-button-style: black;
    width: 160px;
    height: 40px;
  }

  /*#googlePayButton {*/
  /*    display: inline-block;*/
  /*}*/
</style>

<body>
  <div class="container p-3 my-4">
    <form class="p-4 rounded-4 bg-white shadow-lg" id="paymentForm" method="POST"
      action="https://payment.onehourtees.com/payment.php">
      <div class="row mb-5">
        <div class="col">
          <h1>Review Payment</h1>
          <p>Please review your payment information. There are no cancellations or refunds once payment is made and all
            sales are final. If you have any questions, please email
            <a href="mailto:help@prowrestlingtees.com">help@prowrestlingtees.com</a> for further
            assistance.
          </p>
        </div>
      </div>
      <div class="row mb-5">
        <div class="col">
          <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between">
              <div>
                <span>Name</span>
              </div>
              <span>Peggy Hill</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <div>
                <span>Sales Agent</span>
              </div>
              <span>Ryan (ryan@onehourtees.com)</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <div>
                <span>Invoice Number</span>
              </div>
              <span>OHT12345</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <div>
                <span>Payment Method</span>
              </div>
              <span><google-pay-button environment="TEST" button-color="black"
                  button-type="plain"></google-pay-button></span>
              <span><img src="images/apple-pay-mark.svg" width="40"><img src="images/google-pay-mark.svg"
                  width="40"><img src="images/credit-card-mark.svg" width="170"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <div>
                <h6 class="my-0">Payment Total (USD)</h6>
              </div>
              <span><strong class="text-success">$2,345.67</strong></span>
            </li>
          </ul>
        </div>
      </div>
      <div class="row text-end">
        <div class="col">
          <button type="submit" class="btn btn-primary" id="payBtn">Submit Payment</button>
        </div>
      </div>
    </form>

    <!-- Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="termsModalLabel">Terms And Conditions</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>All orders may take up to 10 days, excluding weekends and holidays to process and ship. Once shipped, it
              may take up to 7 business days domestically and 30 business days internationally to receive your order.
              Due to color/size shortages we may need to replace your shirt with a color similar. By selecting Place
              Order, you agree to our <a href="/privacy-policy" target="_blank">privacy policy</a>
              and understanding the terms of <a href="/shipping-info" target="_blank">our shipping</a> and <a
                href="/return-policy" target="_blank">return
                policy</a>.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>

    </div>
  </div>


  <script>
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
  </script>

  <script>
    function formatNumber(e) {
      var rex = /(^\d{2})|(\d{1,3})(?=\d{1,3}|$)/g,
        val = this.value.replace(/^0+|\.|,/g, ""),
        res

      if (val.length) {
        res = Array.prototype.reduce.call(val,
          (p, c) => c + p)            // reverse the pure numbers string
          .match(rex)                                            // get groups in array
          .reduce((p, c, i) => i - 1 ? p + "," + c : p + "." + c) // insert (.) and (,) accordingly
        res += /\.|,/.test(res) ? "" : ".0"                              // test if res has (.) or (,) in it
        this.value = Array.prototype.reduce.call(res, (p, c) => c + p)    // reverse the string and display
      }
    }

    var ni = document.getElementById("numin")

    ni.addEventListener("keyup", formatNumber)
  </script>

</body>

</html>
<!-- Braintree Javascript SDK -->
<script>
  $(() => {

    safari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent) //check if safari
    if (!safari) {
      $('.apple-pay-button').hide()
    }

    let form = document.querySelector('#paymentForm'),
      submit = document.querySelector('#payBtn'),
      paymentsClient = new google.payments.api.PaymentsClient({
        environment: 'TEST' // Or 'PRODUCTION'
      }),
      appleButton = document.querySelector('.apple-pay-button'),
      googleButton = paymentsClient.createButton({
        buttonColor: 'default',
        buttonType: 'plain',
        onClick: function () { }
      })
    googleButton.setAttribute('id', 'googlePayButton')
    document.getElementById('express').appendChild(googleButton)

    braintree.client.create({
      authorization: 'sandbox_zjp3j98j_8mmhcspnnvv3vd73'
    }, function (clientErr, clientInstance) {
      if (clientErr) {
        return
      }
      braintree.dataCollector.create({
        client: clientInstance
      }, function (err, dataCollectorInstance) {
        if (err) {
          // Handle error in creation of data collector
          return
        }
        // At this point, you should access the dataCollectorInstance.deviceData value and provide it
        // to your server, e.g. by injecting it into your form as a hidden input.
        let deviceData = dataCollectorInstance.deviceData

        braintree.hostedFields.create({
          client: clientInstance,
          styles: {
            'input': {
              'font-size': '1rem',
              'line-height': '1.5'
            },
            'input.invalid': {
              'color': 'red'
            },
            'input.valid': {
              'color': 'green'
            },
            'input::placeholder': {
              'color': '#dee2e6',
              'font-size': '1rem'
            }
          },
          fields: {
            number: {
              container: '#creditCardNumber',
              placeholder: 'Enter Credit Card Number'
            },
            cvv: {
              container: '#securityCode',
              placeholder: 'Enter CVV Code'
            },
            expirationDate: {
              container: '#expirationDate',
              placeholder: 'Enter Expiration Date (MM/YY)'
            },
            cardholderName: {
              container: '#nameOnCard',
              placeholder: 'Enter Name On Card'
            },
            postalCode: {
              container: '#billingZipCode',
              placeholder: 'Enter Billing Zip Code'
            }
          }
        }, function (hostedFieldsErr, hostedFieldsInstance) {
          if (hostedFieldsErr) {

            console.error(hostedFieldsErr)
            return
          }

          form.addEventListener('submit', function (event) {

            event.preventDefault()
            hostedFieldsInstance.tokenize(function (tokenizeErr, payload) {
              if (tokenizeErr) {
                if (tokenizeErr?.details?.invalidFieldKeys?.length > 0) {
                  tokenizeErr.details.invalidFieldKeys.forEach((key, index) => {
                    let fieldId = tokenizeErr?.details?.invalidFields[key]?.id
                    hostedFieldsInstance.addClass(key, 'invalid')
                    if (fieldId !== null) {
                      document.getElementById(fieldId + "-error").classList.remove('hidden')
                    }
                  })
                }
                return
              }

              //set payload.nonce as the value of the hidden input
              document.getElementById('nonce').value = payload.nonce
              document.getElementById('deviceData').value = deviceData
              document.getElementById('method').value = payload.type
              form.submit()
            })
          }, false)
        })
        // Google Pay Start
        braintree.googlePayment.create({
          client: clientInstance,
          googlePayVersion: 2,
          googleMerchantId: 'merchant-id-from-google' // Optional in sandbox; if set in sandbox, this value must be a valid production Google Merchant ID
        }, function (googlePaymentErr, googlePaymentInstance) {
          paymentsClient.isReadyToPay({
            // see https://developers.google.com/pay/api/web/reference/object#IsReadyToPayRequest
            apiVersion: 2,
            apiVersionMinor: 0,
            allowedPaymentMethods: googlePaymentInstance.createPaymentDataRequest().allowedPaymentMethods,
            existingPaymentMethodRequired: true // Optional
          }).then(function (response) {
            if (response.result) {
              googleButton.addEventListener('click', function (event) {
                if (!form.checkValidity()) {
                  form.reportValidity()
                  return
                }
                event.preventDefault()
                let paymentDataRequest = googlePaymentInstance.createPaymentDataRequest({
                  transactionInfo: {
                    currencyCode: 'USD',
                    totalPriceStatus: 'FINAL',
                    totalPrice: document.getElementById('numin').value // Your amount
                  }
                })

                // We recommend collecting billing address information, at minimum
                // billing postal code, and passing that billing postal code with all
                // Google Pay card transactions as a best practice.
                // See all available options at https://developers.google.com/pay/api/web/reference/object
                var cardPaymentMethod = paymentDataRequest.allowedPaymentMethods[0]
                cardPaymentMethod.parameters.billingAddressRequired = true
                cardPaymentMethod.parameters.billingAddressParameters = {
                  format: 'FULL',
                  phoneNumberRequired: true
                }

                paymentsClient.loadPaymentData(paymentDataRequest).then(function (paymentData) {
                  googlePaymentInstance.parseResponse(paymentData, function (err, result) {
                    if (err) {
                      // Handle parsing error
                    }
                    //set payload.nonce as the value of the hidden input
                    document.getElementById('nonce').value = result.nonce
                    document.getElementById('deviceData').value = deviceData
                    document.getElementById('method').value = result.type


                    form.submit()

                  })
                }).catch(function (err) {
                  // Handle errors
                })
              })
            }
          }).catch(function (err) {
            // Handle errors
          })
        })
        // Good Pay End

        //Apple Pay Start
        if (window.ApplePaySession && ApplePaySession.supportsVersion(3) && ApplePaySession.canMakePayments()) {


          braintree.applePay.create({
            client: clientInstance
          }, function (applePayErr, applePayInstance) {
            if (applePayErr) {
              console.error('Error creating applePayInstance:', applePayErr)
              return
            }
            appleButton.addEventListener('click', function () {
              if (!form.checkValidity()) {
                form.reportValidity()
                return
              }
              let paymentRequest = applePayInstance.createPaymentRequest({
                merchantIdentifier: 'merchant.com.prowrestlingtees.staging',
                total: {
                  label: 'OneHourTees',
                  amount: document.getElementById('numin').value
                },

                // We recommend collecting billing address information, at minimum
                // billing postal code, and passing that billing postal code with
                // all Apple Pay transactions as a best practice.
                requiredBillingContactFields: ["postalAddress"]
              })

              var session = new ApplePaySession(3, paymentRequest)
              console.log(paymentRequest)


              session.onvalidatemerchant = function (event) {
                console.log(event)
                applePayInstance.performValidation({
                  validationURL: event.validationURL,
                  displayName: 'OneHourTees'
                }, function (err, merchantSession) {
                  if (err) {
                    console.log('Error validating merchant:', err)
                    // You should show an error to the user, e.g. 'Apple Pay failed to load.'
                    return
                  }
                  session.completeMerchantValidation(merchantSession)
                })
              }
              session.onpaymentauthorized = function (event) {
                console.log('Your shipping address is:', event.payment.shippingContact)

                applePayInstance.tokenize({
                  token: event.payment.token
                }, function (tokenizeErr, payload) {
                  if (tokenizeErr) {
                    console.error('Error tokenizing Apple Pay:', tokenizeErr)
                    session.completePayment(ApplePaySession.STATUS_FAILURE)
                    return
                  }

                  // Send payload.nonce to your server.
                  console.log('nonce:', payload.nonce)

                  // If requested, address information is accessible in event.payment
                  // and may also be sent to your server.
                  console.log('billingPostalCode:', event.payment.billingContact.postalCode)

                  // After you have transacted with the payload.nonce,
                  // call 'completePayment' to dismiss the Apple Pay sheet.
                  session.completePayment(ApplePaySession.STATUS_SUCCESS)
                })
              }
              console.log(session)
              session.begin()
              console.log(session)


            })


            // Set up your Apple Pay button here
          })


          // This device supports version 3 of Apple Pay.
        }
        //Apple Pay End


      })
    })
  })
</script>